#cloud-config
hostname: bpc-rp
manage_etc_hosts: true

users:
  - name: bmanager
    groups: [sudo]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUB_KEY}

package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - ufw
  - fail2ban
  - qemu-guest-agent
  - dnsmasq
  - nftables
  - debian-keyring
  - debian-archive-keyring
  - apt-transport-https
  - gpg

write_files:
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      KbdInteractiveAuthentication no
      X11Forwarding no

runcmd:
  - [ bash, -lc, |
       set -e
       
       # Guest agent (static unit on some images)
       systemctl start qemu-guest-agent || true
       
       # Reload SSH safely
       systemctl reload ssh || systemctl reload sshd || true
       
       # -----------------------------
       # UFW (protect RP host services)
       # -----------------------------
       ufw --force reset || true
       ufw default deny incoming
       ufw default allow outgoing
       
       # ALWAYS allow SSH first
       ufw allow 22/tcp
       
       # Web traffic
       ufw allow 80/tcp
       ufw allow 443/tcp
       
       ufw --force enable || true
       ]
                  
  # ---------------------------------------
  # vmbr1 DHCP + NAT gateway for HomeAssistant
  # ---------------------------------------
  - [ bash, -lc, |
    set -euo pipefail

    INTERNAL_CIDR="10.10.10.1/24"
    INTERNAL_NET="10.10.10.0/24"

    # Fixed lease for HAOS (your deterministic MAC)
    HA_MAC="52:54:00:12:34:56"
    HA_IP="10.10.10.10"

    RANGE_START="10.10.10.50"
    RANGE_END="10.10.10.200"

    # Detect WAN interface by default route (vmbr0 side)
    WAN_IF="$(ip route show default | awk '{print $5; exit}')"

    # Detect internal interface by the internal IP (vmbr1 side)
    INTERNAL_IF="$(ip -o -4 addr show | awk -v cidr="${INTERNAL_CIDR}" '$0 ~ cidr {print $2; exit}')"

    if [ -z "${WAN_IF}" ] || [ -z "${INTERNAL_IF}" ]; then
      echo "Could not detect WAN/INTERNAL iface. WAN_IF=${WAN_IF} INTERNAL_IF=${INTERNAL_IF}" >&2
      ip -o -4 addr show >&2
      ip route show >&2
      exit 1
    fi

    echo "WAN_IF=${WAN_IF}" >&2
    echo "INTERNAL_IF=${INTERNAL_IF}" >&2

    # Enable IPv4 forwarding
    cat >/etc/sysctl.d/99-ipforward.conf <<'EOF'
    net.ipv4.ip_forward=1
    EOF
    sysctl -p /etc/sysctl.d/99-ipforward.conf

    # dnsmasq: DHCP only on internal interface
    cat >/etc/dnsmasq.d/vmbr1.conf <<EOF
    interface=${INTERNAL_IF}
    bind-interfaces

    dhcp-range=${RANGE_START},${RANGE_END},255.255.255.0,12h
    dhcp-option=option:router,10.10.10.1
    dhcp-option=option:dns-server,10.10.10.1

    dhcp-host=${HA_MAC},${HA_IP},haos-01,infinite
    log-dhcp
    EOF

    systemctl enable --now dnsmasq
    systemctl restart dnsmasq

    # nftables: NAT + forwarding control
    cat >/etc/nftables.conf <<EOF
    flush ruleset

    table inet filter {
      chain input {
        type filter hook input priority 0;
        policy drop;

        iif lo accept
        ct state established,related accept

        # Allow SSH + HTTP/HTTPS to RP
        tcp dport {22,80,443} accept

        # ICMP (optional)
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept
      }

      chain forward {
        type filter hook forward priority 0;
        policy drop;

        ct state established,related accept

        # Allow HA network to reach the internet via RP (NAT)
        iif "${INTERNAL_IF}" oif "${WAN_IF}" ip saddr ${INTERNAL_NET} accept

        # Allow RP to access HA UI on 8123 (reverse proxy -> HA)
        iif "${WAN_IF}" oif "${INTERNAL_IF}" ip daddr ${INTERNAL_NET} tcp dport 8123 accept
      }

      chain output {
        type filter hook output priority 0;
        policy accept;
      }
    }

    table ip nat {
      chain postrouting {
        type nat hook postrouting priority 100;
        oif "${WAN_IF}" ip saddr ${INTERNAL_NET} masquerade
      }
    }
    EOF

    systemctl enable --now nftables
    nft -f /etc/nftables.conf
  ]
                   
   # -----------------------------
   # Install Caddy (simple TLS reverse proxy)
   # -----------------------------
   - [ bash, -lc, |
     set -euo pipefail
     apt-get install -y debian-keyring debian-archive-keyring apt-transport-https gpg || true
     curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
     curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
     apt-get update
     apt-get install -y caddy
     systemctl enable --now caddy || true
   ]
