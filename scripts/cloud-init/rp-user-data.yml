#cloud-config
hostname: bpc-rp
manage_etc_hosts: true

users:
  - name: bmanager
    groups: [sudo]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUB_KEY}

package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - ufw
  - fail2ban
  - qemu-guest-agent
  - dnsmasq
  - nftables
  - debian-keyring
  - debian-archive-keyring
  - apt-transport-https
  - gpg

write_files:
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      KbdInteractiveAuthentication no
      X11Forwarding no

runcmd:
  # Guest agent (do not fail cloud-init if it can't start yet)
  - systemctl enable --now qemu-guest-agent || true

  # SSH reload
  - systemctl reload ssh || systemctl reload sshd || true

  # -----------------------------
  # UFW (protect RP host services)
  # -----------------------------
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable

  # ---------------------------------------
  # vmbr1 DHCP + NAT gateway for HomeAssistant
  # ---------------------------------------
  - |
    echo "[cloud-init] vmbr1 gateway setup start" >> /var/log/cloud-init-output.log

    INTERNAL_CIDR="10.10.10.1/24"
    INTERNAL_NET="10.10.10.0/24"

    HA_MAC="52:54:00:12:34:56"
    HA_IP="10.10.10.10"

    RANGE_START="10.10.10.50"
    RANGE_END="10.10.10.200"

    WAN_IF="$(ip route show default | awk '{print $5; exit}')"
    INTERNAL_IF="$(ip -o -4 addr show | awk -v cidr="${INTERNAL_CIDR}" '$0 ~ cidr {print $2; exit}')"

    echo "WAN_IF=${WAN_IF} INTERNAL_IF=${INTERNAL_IF}" >> /var/log/cloud-init-output.log

    if [ -z "${WAN_IF}" ] || [ -z "${INTERNAL_IF}" ]; then
      echo "ERROR: interface detection failed" >> /var/log/cloud-init-output.log
      exit 1
    fi

    # Enable IPv4 forwarding
    cat >/etc/sysctl.d/99-ipforward.conf <<'EOF'
      net.ipv4.ip_forward=1
    EOF
    
    sysctl -p /etc/sysctl.d/99-ipforward.conf
  
    # dnsmasq (DHCP only, no DNS listener)
    cat >/etc/dnsmasq.d/vmbr1.conf <<'EOF'
    interface=__INTERNAL_IF__
    bind-interfaces
    port=0
    
    dhcp-range=10.10.10.50,10.10.10.200,255.255.255.0,12h
    dhcp-option=option:router,10.10.10.1
    dhcp-option=option:dns-server,1.1.1.1
  
    dhcp-host=52:54:00:12:34:56,10.10.10.10,haos-01,infinite
    log-dhcp
    EOF
    
    sed -i "s/__INTERNAL_IF__/${INTERNAL_IF}/g" /etc/dnsmasq.d/vmbr1.conf
    
    systemctl enable dnsmasq
    systemctl restart dnsmasq
  
    # nftables (UFW keeps filter, nft handles NAT only)
    cat >/etc/nftables.conf <<'EOF'
    flush ruleset
    
    table ip nat {
      chain postrouting {
        type nat hook postrouting priority 100;
        oif "__WAN_IF__" ip saddr 10.10.10.0/24 masquerade
      }
    }
    EOF
  
    sed -i "s/__WAN_IF__/${WAN_IF}/g" /etc/nftables.conf
    
    systemctl enable nftables
    nft -f /etc/nftables.conf
    
    echo "[cloud-init] vmbr1 gateway setup done" >> /var/log/cloud-init-output.log

  # -----------------------------
  # Install Caddy (TLS reverse proxy)
  # -----------------------------
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' \
    | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' \
    | tee /etc/apt/sources.list.d/caddy-stable.list
  - apt-get update
  - apt-get install -y caddy
  - systemctl enable --now caddy || true
