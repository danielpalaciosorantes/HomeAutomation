#cloud-config
hostname: bpc-rp
manage_etc_hosts: true

users:
  - name: bmanager
    groups: [sudo]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUB_KEY}

package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - ufw
  - fail2ban
  - qemu-guest-agent
  - dnsmasq
  - nftables
  - debian-keyring
  - debian-archive-keyring
  - apt-transport-https
  - gpg

write_files:
  # SSH hardening
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      KbdInteractiveAuthentication no
      X11Forwarding no

  # Central log file for cloud-init networking / firewall steps
  - path: /var/log/rp-bootstrap.log
    permissions: "0644"
    content: |
      === RP bootstrap log ===

runcmd:
  # ---------------------------------------------------
  # Base services + SSH reload
  # ---------------------------------------------------
  - [ bash, -lc, |
                   set -euo pipefail
                   exec > >(tee -a /var/log/rp-bootstrap.log) 2>&1
                   
                   echo "[STEP] Base services"
                   systemctl enable --now qemu-guest-agent || true
                   systemctl reload ssh || systemctl reload sshd
                   ]
                   
                   # ---------------------------------------------------
                   # UFW â€“ protect the reverse proxy itself
                   # ---------------------------------------------------
                   - [ bash, -lc, |
                   set -euo pipefail
                   exec > >(tee -a /var/log/rp-bootstrap.log) 2>&1
                   
                   echo "[STEP] Configuring UFW"
                   ufw --force reset
                   ufw default deny incoming
                   ufw default allow outgoing
                   ufw allow 22/tcp
                   ufw allow 80/tcp
                   ufw allow 443/tcp
                   ufw --force enable
                   
                   ufw status verbose
                   ]
                   
                   # ---------------------------------------------------
                   # vmbr1 DHCP + NAT gateway for Home Assistant
                   # ---------------------------------------------------
                   - [ bash, -lc, |
                   set -euo pipefail
                   exec > >(tee -a /var/log/rp-bootstrap.log) 2>&1
                   
                   echo "[STEP] Setting up vmbr1 DHCP + NAT"
                   
                   INTERNAL_CIDR="10.10.10.1/24"
                   INTERNAL_NET="10.10.10.0/24"
                   
                   HA_MAC="52:54:00:12:34:56"
                   HA_IP="10.10.10.10"
                   
                   RANGE_START="10.10.10.50"
                   RANGE_END="10.10.10.200"
                   
                   WAN_IF="$(ip route show default | awk '{print $5; exit}')"
                   INTERNAL_IF="$(ip -o -4 addr show | awk -v cidr="${INTERNAL_CIDR}" '$0 ~ cidr {print $2; exit}')"
                   
                   echo "Detected WAN_IF=${WAN_IF}"
                   echo "Detected INTERNAL_IF=${INTERNAL_IF}"
                   
                   if [[ -z "${WAN_IF}" || -z "${INTERNAL_IF}" ]]; then
                   echo "ERROR: interface detection failed"
                   ip -o -4 addr show
                   ip route show
                   exit 1
                   fi
                   
                   echo "[STEP] Enabling IPv4 forwarding"
                   cat >/etc/sysctl.d/99-ipforward.conf <<'EOF'
    net.ipv4.ip_forward=1
      EOF
      sysctl -p /etc/sysctl.d/99-ipforward.conf

      echo "[STEP] Configuring dnsmasq (DHCP only)"
      cat >/etc/dnsmasq.d/vmbr1.conf <<EOF
      interface=${INTERNAL_IF}
    bind-interfaces
      port=0
      
      dhcp-range=${RANGE_START},${RANGE_END},255.255.255.0,12h
      dhcp-option=option:router,10.10.10.1
      dhcp-option=option:dns-server,1.1.1.1
      
      dhcp-host=${HA_MAC},${HA_IP},haos-01,infinite
      log-dhcp
      EOF

      systemctl enable dnsmasq
      systemctl restart dnsmasq
      systemctl --no-pager status dnsmasq || true

      echo "[STEP] Configuring nftables NAT"
      cat >/etc/nftables.conf <<EOF
      flush ruleset
      
      table ip nat {
                     chain postrouting {
      type nat hook postrouting priority 100;
      oif "${WAN_IF}" ip saddr ${INTERNAL_NET} masquerade
  }
}
EOF

      systemctl enable nftables
      nft -f /etc/nftables.conf
      nft list ruleset
    ]

  # ---------------------------------------------------
  # Caddy reverse proxy
  # ---------------------------------------------------
  - [ bash, -lc, |
      set -euo pipefail
      exec > >(tee -a /var/log/rp-bootstrap.log) 2>&1

      echo "[STEP] Installing Caddy"

      curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' \
                                         | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
                                         
                                         curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' \
                                         | tee /etc/apt/sources.list.d/caddy-stable.list
                                         
                                         apt-get update
                                         apt-get install -y caddy
                                         
                                         systemctl enable --now caddy
                                         systemctl --no-pager status caddy || true
                                         ]
      
      final_message: |
        RP bootstrap completed.
        Logs: /var/log/rp-bootstrap.log
