#cloud-config
hostname: ha-01
manage_etc_hosts: true

users:
  - name: bmanager
    groups: [sudo]
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUB_KEY}

package_update: true
package_upgrade: true
packages:
  - ca-certificates
  - curl
  - ufw
  - qemu-guest-agent

write_files:
  - path: /etc/ssh/sshd_config.d/99-hardening.conf
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      KbdInteractiveAuthentication no
      X11Forwarding no

runcmd:
  - systemctl enable --now qemu-guest-agent
  - systemctl reload ssh || systemctl reload sshd

  # Firewall policy
  - ufw --force reset
  - ufw default deny incoming
  - ufw default deny outgoing

  # Allow inbound ONLY from reverse proxy to Home Assistant UI
  - ufw allow from ${RP_LAN_IP} to any port 8123 proto tcp

  # Allow outbound DNS (UDP+TCP 53) and web (HTTP/HTTPS)
  - ufw allow out 53/udp
  - ufw allow out 53/tcp
  - ufw allow out 80/tcp
  - ufw allow out 443/tcp

  - ufw --force enable
